<project_specification>
  <project_name>BaZi Master - 全球化算命平台</project_name>

  <overview>
    构建一个面向全球用户的算命平台，以八字命理为核心，支持塔罗、星座、周易、紫微斗数等多种算命类型。
    用户输入生辰信息后程序自动计算命盘，预留 AI 解读接口（支持国产主流 AI 模型 API）。
    目标用户：40% 国内中文用户，60% 海外英语用户（非洲、欧美、南美）。
    商业模式：免费使用，基础功能无需登录，核心功能需登录。
  </overview>

  <technology_stack>
    <frontend>
      <framework>React with Vite</framework>
      <styling>Tailwind CSS</styling>
      <state_management>React hooks and context</state_management>
      <routing>React Router for navigation</routing>
      <i18n>react-i18next for internationalization (zh-CN, en-US)</i18n>
      <charts>ECharts for visualization (五行图、命盘图)</charts>
      <port>3000</port>
    </frontend>
    <backend>
      <runtime>Node.js with Express</runtime>
      <database>PostgreSQL with Prisma ORM</database>
      <cache>Redis for session and calculation cache</cache>
      <auth>JWT + OAuth2 (Google, WeChat)</auth>
      <ai_integration>预留接口支持：通义千问、文心一言、智谱 AI</ai_integration>
    </backend>
    <communication>
      <api>RESTful endpoints</api>
      <realtime>WebSocket for AI streaming responses</realtime>
    </communication>
  </technology_stack>

  <user_system>
    <guest_mode>
      无需登录可使用：
      - 八字基础排盘（四柱、五行统计）
      - 星座查询
      - 塔罗单张抽牌
      - 周易简易起卦
    </guest_mode>
    <registered_user>
      登录后可使用：
      - 完整八字解读（十神、大运、流年）
      - AI 智能解读
      - 历史记录保存
      - 多命盘对比
      - 紫微斗数完整命盘
      - 塔罗牌阵解读
      - 收藏与分享功能
    </registered_user>
    <auth_methods>
      - Email + Password
      - Google OAuth (海外用户)
      - WeChat OAuth (国内用户)
    </auth_methods>
  </user_system>

  <core_features>
    <bazi_module>
      <name>八字命理（核心模块）</name>
      <basic_features>
        - 输入：出生年月日时、性别、出生地（可选，用于真太阳时校正）
        - 四柱排盘：年柱、月柱、日柱、时柱
        - 天干地支显示
        - 五行统计与分布图
        - 日主强弱判断
      </basic_features>
      <advanced_features>
        - 十神分析（正官、七杀、正印、偏印、比肩、劫财、食神、伤官、正财、偏财）
        - 大运排盘（10年一运）
        - 流年分析
        - 神煞查询（天乙贵人、文昌、桃花等）
        - 五行喜忌建议
        - 真太阳时校正（根据经纬度）
      </advanced_features>
      <calculation_engine>
        - 万年历算法（支持 1900-2100 年）
        - 节气精确计算
        - 农历阳历互转
      </calculation_engine>
    </bazi_module>

    <tarot_module>
      <name>塔罗牌</name>
      <basic_features>
        - 单张抽牌（每日一卡）
        - 78张韦特塔罗牌库
        - 正逆位显示
        - 基础牌义解读
      </basic_features>
      <advanced_features>
        - 三张牌阵（过去-现在-未来）
        - 凯尔特十字牌阵
        - AI 综合解读
        - 历史抽牌记录
      </advanced_features>
    </tarot_module>

    <zodiac_module>
      <name>星座运势</name>
      <features>
        - 12星座查询
        - 每日/每周/每月运势
        - 星座配对
        - 上升星座计算（需出生时间地点）
      </features>
    </zodiac_module>

    <iching_module>
      <name>周易占卜</name>
      <basic_features>
        - 数字起卦（输入三个数字）
        - 时间起卦（梅花易数）
        - 64卦显示与基础卦辞
      </basic_features>
      <advanced_features>
        - 变卦分析
        - 六爻详解
        - AI 卦象解读
      </advanced_features>
    </iching_module>

    <ziwei_module>
      <name>紫微斗数</name>
      <features>
        - 完整命盘排盘（12宫位）
        - 主星、辅星显示
        - 四化飞星
        - 大限流年
        - 命盘图形化展示
      </features>
      <note>此模块复杂度高，建议作为 V2 功能</note>
    </ziwei_module>
  </core_features>

  <database_schema>
    <users>
      - id, email, password_hash, name, avatar_url
      - locale (zh-CN, en-US)
      - auth_provider (local, google, wechat)
      - created_at, last_login_at
      - preferences (JSON: theme, notifications)
    </users>

    <bazi_records>
      - id, user_id (nullable for guests), session_id
      - birth_year, birth_month, birth_day, birth_hour
      - gender, birth_location, timezone_offset
      - calculated_result (JSON: 四柱、五行、十神等)
      - created_at
    </bazi_records>

    <tarot_readings>
      - id, user_id, session_id
      - spread_type (single, three_card, celtic_cross)
      - cards (JSON array: card_id, position, reversed)
      - ai_interpretation
      - created_at
    </tarot_readings>

    <iching_readings>
      - id, user_id, session_id
      - method (number, time)
      - hexagram_id, changing_lines
      - question, ai_interpretation
      - created_at
    </iching_readings>

    <user_favorites>
      - id, user_id, record_type, record_id
      - created_at
    </user_favorites>
  </database_schema>

  <api_endpoints>
    <auth>
      - POST /api/auth/register
      - POST /api/auth/login
      - POST /api/auth/logout
      - POST /api/auth/oauth/google
      - POST /api/auth/oauth/wechat
      - GET /api/auth/me
    </auth>

    <bazi>
      - POST /api/bazi/calculate (基础排盘，无需登录)
      - POST /api/bazi/full-analysis (完整分析，需登录)
      - GET /api/bazi/records (历史记录，需登录)
      - POST /api/bazi/ai-interpret (AI解读，需登录)
    </bazi>

    <tarot>
      - POST /api/tarot/draw (抽牌)
      - GET /api/tarot/cards (牌库信息)
      - POST /api/tarot/ai-interpret (AI解读，需登录)
      - GET /api/tarot/history (历史，需登录)
    </tarot>

    <iching>
      - POST /api/iching/divine (起卦)
      - GET /api/iching/hexagrams (64卦信息)
      - POST /api/iching/ai-interpret (AI解读，需登录)
    </iching>

    <zodiac>
      - GET /api/zodiac/:sign (星座信息)
      - GET /api/zodiac/:sign/horoscope (运势)
    </zodiac>

    <ai>
      - POST /api/ai/interpret (通用AI解读接口)
      - GET /api/ai/providers (可用AI提供商)
    </ai>
  </api_endpoints>

  <ui_layout>
    <pages>
      - / (首页：功能入口卡片)
      - /bazi (八字排盘)
      - /tarot (塔罗牌)
      - /iching (周易占卜)
      - /zodiac (星座运势)
      - /ziwei (紫微斗数，V2)
      - /profile (个人中心，需登录)
      - /history (历史记录，需登录)
    </pages>

    <design_style>
      - 神秘感 + 现代简洁
      - 主色调：深紫色 (#2D1B4E)、金色 (#D4AF37)
      - 背景：渐变深色或星空纹理
      - 卡片：毛玻璃效果
      - 字体：中文用思源宋体，英文用 Cinzel
    </design_style>
  </ui_layout>

  <internationalization>
    <supported_locales>
      - zh-CN (简体中文)
      - en-US (English)
    </supported_locales>
    <terminology_translation>
      - 天干: Heavenly Stems
      - 地支: Earthly Branches
      - 五行: Five Elements (Wood, Fire, Earth, Metal, Water)
      - 十神: Ten Gods
      - 大运: Major Luck Cycles
      - 流年: Annual Fortune
    </terminology_translation>
    <detection>
      - 根据浏览器语言自动检测
      - 用户可手动切换
      - 语言偏好存储在 localStorage 和用户配置
    </detection>
  </internationalization>

  <implementation_steps>
    <phase_1>
      <title>基础架构</title>
      <tasks>
        - 初始化 React + Vite 前端项目
        - 配置 Tailwind CSS
        - 搭建 Express 后端
        - 配置 PostgreSQL + Prisma
        - 实现 i18n 框架
      </tasks>
    </phase_1>

    <phase_2>
      <title>八字核心模块</title>
      <tasks>
        - 实现万年历算法
        - 实现四柱排盘计算
        - 实现五行统计
        - 构建八字输入表单
        - 构建命盘展示组件
      </tasks>
    </phase_2>

    <phase_3>
      <title>用户系统</title>
      <tasks>
        - 实现 JWT 认证
        - 实现 Google OAuth
        - 实现微信 OAuth
        - 构建登录/注册页面
        - 实现历史记录功能
      </tasks>
    </phase_3>

    <phase_4>
      <title>其他算命模块</title>
      <tasks>
        - 实现塔罗牌模块
        - 实现星座模块
        - 实现周易模块
      </tasks>
    </phase_4>

    <phase_5>
      <title>AI 解读集成</title>
      <tasks>
        - 设计 AI 接口抽象层
        - 集成通义千问 API
        - 集成文心一言 API
        - 构建解读展示组件
      </tasks>
    </phase_5>
  </implementation_steps>

  <success_criteria>
    <functionality>
      - 八字排盘计算准确（与专业软件对比验证）
      - 多语言切换流畅
      - 游客/登录用户权限正确区分
      - AI 解读接口可扩展
    </functionality>
    <performance>
      - 八字计算响应 < 500ms
      - 页面首屏加载 < 2s
      - 支持 1000+ 并发用户
    </performance>
    <user_experience>
      - 移动端响应式适配
      - 无障碍支持 (WCAG 2.1 AA)
      - 深色/浅色主题切换
    </user_experience>
  </success_criteria>

</project_specification>
